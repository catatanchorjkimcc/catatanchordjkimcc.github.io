<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catatan Chord Lagu</title>
  <style>
    :root {
      --bg: #0e0f13;
      --card: #161822;
      --card-soft: #1d2030;
      --primary: #4da3ff;
      --text: #e9ebf0;
      --muted: #9aa0b4;
      --border: #2a2d3e;
      --shadow: rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: var(--transition);
      min-height: 100vh;
    }
    h1 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      padding: 16px 20px;
      background: linear-gradient(180deg, #161822, #121420);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 4px var(--shadow);
    }
    h2 {
      font-size: 16px;
      font-weight: 500;
      margin: 20px 0 10px;
      color: var(--primary);
    }
    button {
      appearance: none;
      border: none;
      background: var(--card-soft);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 1px 3px var(--shadow);
    }
    button:hover {
      background: #262a3d;
      transform: translateY(-1px);
    }
    button:active {
      transform: scale(0.96);
    }
    .hidden {
      display: none;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: var(--bg);
      border-radius: 18px;
      padding: 20px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 10px 30px var(--shadow);
      width: 100%;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
    }

    /* PAGE LIST */
    #pageList {
      padding: 20px;
    }
    .group {
      margin-bottom: 30px;
    }
    .song-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      text-align: left;
      margin-bottom: 12px;
      padding: 16px 20px;
      background: var(--card);
      border: 1px solid var(--border);
      font-size: 16px;
      border-radius: 14px;
      box-shadow: 0 2px 6px var(--shadow);
      cursor: pointer;
    }
    .song-item:hover {
      background: var(--card-soft);
    }
    .song-title {
      flex: 1;
    }
    .menu-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      margin-left: 10px;
    }
    .menu {
      position: relative;
      display: inline-block;
    }
    .menu-content {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--shadow);
      z-index: 100;
      min-width: 120px;
    }
    .menu-content button {
      width: 100%;
      text-align: left;
      border-radius: 0;
      margin: 0;
      padding: 10px 14px;
    }
    .menu-content button:first-child {
      border-radius: 8px 8px 0 0;
    }
    .menu-content button:last-child {
      border-radius: 0 0 8px 8px;
    }

    /* EDITOR IN MODAL */
    .editor-modal textarea {
      width: 100%;
      height: 300px;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      font-size: 16px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      resize: vertical;
      transition: var(--transition);
      white-space: pre;
    }
    .editor-modal textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(77, 163, 255, 0.2);
    }
    .editor-modal .actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    /* VIEWER */
    .viewer {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      margin-top: 16px;
      line-height: 2;
      box-shadow: 0 4px 12px var(--shadow);
      overflow-x: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre;
    }
    .section {
      font-weight: 700;
      letter-spacing: 0.5px;
      margin: 20px 0 8px;
      color: #ffffff;
      font-size: 18px;
    }
    .chord {
      color: var(--primary);
      font-weight: 600;
    }

    /* TOOLBAR */
    .toolbar {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      background: rgba(14, 15, 19, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 8px var(--shadow);
    }
    .toolbar button {
      font-size: 14px;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .modal-content {
        max-width: 95%;
        padding: 16px;
      }
      .toolbar {
        padding: 10px 16px;
        flex-wrap: wrap;
      }
      .viewer {
        padding: 16px;
        font-size: 14px;
      }
      h1 {
        font-size: 16px;
        padding: 14px 16px;
      }
      .song-item {
        padding: 14px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

<!-- PAGE 1 -->
<div id="pageList" class="fade-in">
  <h1>Daftar Lagu</h1>
  <div style="text-align: right; margin-bottom: 20px;">
    <button onclick="exportSongs()">‚¨á Export</button>
    <label for="importFile" style="margin-left: 10px;">
      <button>üìÅ Import</button>
    </label>
    <input type="file" id="importFile" onchange="importSongs(event)" style="display: none;" />
  </div>
  <div class="group">
    <h2>Ibadah Raya 1</h2>
    <div id="songButtons1"></div>
  </div>
  <div class="group">
    <h2>Ibadah Raya 2</h2>
    <div id="songButtons2"></div>
  </div>
  <div class="group">
    <h2>Ibadah Perayaan Natal</h2>
    <div id="songButtons3"></div>
  </div>
</div>

<!-- PAGE 2 -->
<div id="pageEditor" class="hidden fade-in">
  <button onclick="backToList()">‚¨Ö Kembali</button>
  <h1 id="songTitle"></h1>

  <div class="toolbar">
    <button onclick="transpose(-1)">‚ûñ Transpose</button>
    <button onclick="transpose(1)">‚ûï Transpose</button>
    <button onclick="zoom(1)">üîç+</button>
    <button onclick="zoom(-1)">üîç-</button>
  </div>

  <div id="viewer" class="viewer"></div>
</div>

<!-- MODAL EDIT -->
<div id="editModal" class="modal">
  <div class="modal-content editor-modal">
    <div class="modal-header">
      <h1 id="editTitle"></h1>
      <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
    </div>
    <textarea id="editor" placeholder="Masukkan chord dan lirik di sini..."></textarea>
    <div class="actions">
      <button onclick="saveSong()">üíæ Simpan</button>
    </div>
  </div>
</div>

<script>
  const TOTAL_PER_GROUP = 10;
  const TOTAL = TOTAL_PER_GROUP * 3; // 30 total
  let songs = JSON.parse(localStorage.getItem('songs')) || [];
let titles = JSON.parse(localStorage.getItem('titles')) || [];

// üîß Perbaiki panjang array (ANTI undefined)
while (songs.length < TOTAL) songs.push('');
while (titles.length < TOTAL)
  titles.push(`Lagu ${titles.length % TOTAL_PER_GROUP + 1}`);

  let current = 0;
  let transposeStep = 0;
  let fontSize = 16;

  const KEYS = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'Bb', 'B'];

  function init() {
  renderGroup('songButtons1', 0, TOTAL_PER_GROUP);
  renderGroup('songButtons2', TOTAL_PER_GROUP, TOTAL_PER_GROUP * 2);
  renderGroup('songButtons3', TOTAL_PER_GROUP * 2, TOTAL_PER_GROUP * 3);
}


  function renderGroup(containerId, start, end) {
    const box = document.getElementById(containerId);
    box.innerHTML = '';
    for (let i = start; i < end; i++) {
      const item = document.createElement('div');
      item.className = 'song-item';
      item.onclick = () => viewSong(i);
      item.innerHTML = `
        <span class="song-title">${titles[i]}</span>
        <div class="menu">
          <button class="menu-btn" onclick="event.stopPropagation(); toggleMenu(${i})">‚ãÆ</button>
          <div id="menu-${i}" class="menu-content">
            <button onclick="event.stopPropagation(); editTitle(${i})">Edit Judul</button>
            <button onclick="event.stopPropagation(); editSong(${i})">Edit Lagu</button>
          </div>
        </div>
      `;
      box.appendChild(item);
    }
  }

  function toggleMenu(i) {
    const menu = document.getElementById(`menu-${i}`);
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  }

  function editTitle(i) {
    const newTitle = prompt('Masukkan judul baru:', titles[i]);
    if (newTitle !== null && newTitle.trim() !== '') {
      titles[i] = newTitle.trim();
      localStorage.setItem('titles', JSON.stringify(titles));
      init();
    }
    toggleMenu(i);
  }

  function viewSong(i) {
    current = i;
    transposeStep = 0;
    document.getElementById('pageList').classList.add('hidden');
    document.getElementById('pageEditor').classList.remove('hidden');
    document.getElementById('songTitle').innerText = titles[i];
    render();
  }

  function editSong(i) {
    current = i;
    document.getElementById('editTitle').innerText = titles[i];
    document.getElementById('editor').value = songs[i];
    document.getElementById('editModal').classList.add('show');
    toggleMenu(i);
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
  }

  function backToList() {
    document.getElementById('pageEditor').classList.add('hidden');
    document.getElementById('pageList').classList.remove('hidden');
  }

  function saveSong() {
    songs[current] = document.getElementById('editor').value;
    localStorage.setItem('songs', JSON.stringify(songs));
    closeModal('editModal');
    init(); // Refresh list if needed
  }

  // ===== TOOLS =====
  function transpose(step) {
    transposeStep += step;
    render();
  }
  function zoom(step) {
    fontSize = Math.min(34, Math.max(12, fontSize + step));
    render();
  }

  // ===== RENDER =====
  function transposeChord(ch) {
    const parts = ch.split('/');
    const transposedParts = parts.map(part => {
      const base = part.match(/^[A-G][#b]?/);
      if (!base) return part;
      const i = KEYS.indexOf(base[0]);
      if (i < 0) return part;
      const nk = KEYS[(i + transposeStep + KEYS.length) % KEYS.length];
      return part.replace(base[0], nk);
    });
    return transposedParts.join('/');
  }

function render() {
  let html = '';

  const chordRegex =
    /(?<!\S)([A-G](?:#|b)?(?:m|maj|min|sus|dim|aug|add)?\d*(?:\/[A-G](?:#|b)?(?:m|maj|min|sus|dim|aug|add)?\d*)?)(?!\S)/g;

  (songs[current] || '').split('\n').forEach(line => {

    if (/^.+\s:\s*$/.test(line)) {
      html += `<div class="section">${line}</div>`;
      return;
    }

    html += line.replace(chordRegex, chord => {
      return `<span class="chord">${transposeChord(chord)}</span>`;
    }) + '<br>';
  });

  const v = document.getElementById('viewer');
  v.style.fontSize = fontSize + 'px';
  v.innerHTML = html;
}




  // ===== IMPORT EXPORT =====
  function exportSongs() {
    const data = { songs, titles };
    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'chord-lagu.json';
    a.click();
  }

  function importSongs(e) {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      const data = JSON.parse(r.result);
      songs = data.songs || Array(TOTAL).fill('');
      titles = data.titles || Array.from({length: TOTAL}, (_, i) => `Lagu ${i % TOTAL_PER_GROUP + 1}`);
      localStorage.setItem('songs', JSON.stringify(songs));
      localStorage.setItem('titles', JSON.stringify(titles));
      init();
    };
    r.readAsText(f);
  }

  init();
</script>
</body>
</html>